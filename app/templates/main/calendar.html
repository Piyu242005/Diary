{% extends "base.html" %}

{% block title %}Calendar - Diary App{% endblock %}

{% block extra_css %}
<style>
.calendar-container {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: var(--shadow-md);
    padding: 2rem;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.calendar-title {
    font-family: var(--font-heading);
    font-size: 1.75rem;
    color: var(--secondary-color);
    margin: 0;
}

.calendar-nav-btn {
    background: var(--primary-light);
    color: var(--primary-color);
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 10px;
    font-weight: 600;
    transition: var(--transition-smooth);
    cursor: pointer;
}

.calendar-nav-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
}

.calendar-weekday {
    font-weight: 600;
    text-align: center;
    padding: 1rem 0.5rem;
    color: var(--text-muted);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.calendar-day {
    aspect-ratio: 1;
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 0.5rem;
    text-align: center;
    cursor: pointer;
    transition: var(--transition-smooth);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    background: var(--bg-color);
}

.calendar-day:hover {
    background-color: var(--primary-light);
    border-color: var(--primary-color);
    transform: scale(1.05);
}

.calendar-day.today {
    border: 2px solid var(--primary-color);
    font-weight: bold;
}

.calendar-day.has-entry {
    background: linear-gradient(135deg, var(--primary-light) 0%, rgba(230, 126, 34, 0.2) 100%);
    font-weight: 600;
}

.calendar-day.empty {
    visibility: hidden;
}

.day-number {
    font-size: 1rem;
    color: var(--text-main);
}

.mood-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-top: 4px;
}

.mood-indicator.happy { background-color: #2ECC71; }
.mood-indicator.excited { background-color: #F1C40F; }
.mood-indicator.neutral { background-color: #95A5A6; }
.mood-indicator.sad { background-color: #3498DB; }
.mood-indicator.angry { background-color: #E74C3C; }

/* Entry Preview Panel */
.entry-preview {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow-sm);
    padding: 1.5rem;
    margin-top: 2rem;
}

.entry-preview-empty {
    text-align: center;
    color: var(--text-muted);
    padding: 3rem;
}

.entry-preview-card {
    border-left: 4px solid var(--primary-color);
    padding-left: 1rem;
    margin-bottom: 1rem;
}

.entry-preview-card:last-child {
    margin-bottom: 0;
}

.mood-legend {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    padding: 1rem 0;
    justify-content: center;
    margin-top: 1rem;
}

.mood-legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-muted);
}

.mood-legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}
</style>
{% endblock %}

{% block content %}
<div class="container fade-in">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="page-title">
                <i class="fas fa-calendar-alt me-2" style="color: var(--primary-color);"></i>
                Calendar View
            </h1>
            <p class="page-subtitle">Track your diary entries across time</p>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar-header">
            <button class="calendar-nav-btn" id="prevMonth">
                <i class="fas fa-chevron-left me-1"></i> Previous
            </button>
            <h2 class="calendar-title" id="currentMonth"></h2>
            <button class="calendar-nav-btn" id="nextMonth">
                Next <i class="fas fa-chevron-right ms-1"></i>
            </button>
        </div>

        <div class="calendar-grid" id="calendarWeekdays">
            <div class="calendar-weekday">Sun</div>
            <div class="calendar-weekday">Mon</div>
            <div class="calendar-weekday">Tue</div>
            <div class="calendar-weekday">Wed</div>
            <div class="calendar-weekday">Thu</div>
            <div class="calendar-weekday">Fri</div>
            <div class="calendar-weekday">Sat</div>
        </div>

        <div class="calendar-grid" id="calendarDays"></div>

        <!-- Mood Legend -->
        <div class="mood-legend">
            <div class="mood-legend-item">
                <span class="mood-legend-dot" style="background-color: #2ECC71;"></span>
                <span>Happy</span>
            </div>
            <div class="mood-legend-item">
                <span class="mood-legend-dot" style="background-color: #F1C40F;"></span>
                <span>Excited</span>
            </div>
            <div class="mood-legend-item">
                <span class="mood-legend-dot" style="background-color: #95A5A6;"></span>
                <span>Neutral</span>
            </div>
            <div class="mood-legend-item">
                <span class="mood-legend-dot" style="background-color: #3498DB;"></span>
                <span>Sad</span>
            </div>
            <div class="mood-legend-item">
                <span class="mood-legend-dot" style="background-color: #E74C3C;"></span>
                <span>Angry</span>
            </div>
        </div>
    </div>

    <!-- Entry Preview Section -->
    <div class="entry-preview" id="entryPreview">
        <h5 class="mb-3"><i class="fas fa-book-open me-2" style="color: var(--primary-color);"></i> Selected Date</h5>
        <div class="entry-preview-empty" id="noEntries">
            <i class="far fa-calendar-alt" style="font-size: 3rem; color: var(--border-color);"></i>
            <p class="mt-3 mb-0">Click on a date to see entries</p>
        </div>
        <div id="entriesContainer" style="display: none;"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDate = new Date();
let entriesData = {};

async function fetchEntries(year, month) {
    try {
        const response = await fetch(`/api/calendar-entries?year=${year}&month=${month}`);
        const data = await response.json();
        
        entriesData = {};
        data.forEach(entry => {
            if (!entriesData[entry.day]) {
                entriesData[entry.day] = [];
            }
            entriesData[entry.day].push(entry);
        });
        
        return entriesData;
    } catch (error) {
        console.error('Error fetching entries:', error);
        return {};
    }
}

async function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    document.getElementById('currentMonth').textContent = 
        new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    // Fetch entries for this month
    await fetchEntries(year, month + 1);
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    
    const calendarDays = document.getElementById('calendarDays');
    calendarDays.innerHTML = '';
    
    // Add empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        calendarDays.appendChild(emptyDay);
    }
    
    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        // Check if today
        if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
            dayElement.classList.add('today');
        }
        
        // Check for entries
        const dayEntries = entriesData[day];
        if (dayEntries && dayEntries.length > 0) {
            dayElement.classList.add('has-entry');
            
            // Add mood indicator
            const mood = dayEntries[0].mood;
            if (mood) {
                const moodIndicator = document.createElement('div');
                moodIndicator.className = `mood-indicator ${mood}`;
                dayElement.innerHTML = `<span class="day-number">${day}</span>`;
                dayElement.appendChild(moodIndicator);
            } else {
                dayElement.innerHTML = `<span class="day-number">${day}</span>`;
            }
        } else {
            dayElement.innerHTML = `<span class="day-number">${day}</span>`;
        }
        
        dayElement.onclick = () => selectDate(year, month, day);
        calendarDays.appendChild(dayElement);
    }
}

function selectDate(year, month, day) {
    const dateStr = new Date(year, month, day).toLocaleDateString('en-US', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
    });
    
    const entriesContainer = document.getElementById('entriesContainer');
    const noEntries = document.getElementById('noEntries');
    const dayEntries = entriesData[day];
    
    const moodEmojis = {
        'happy': 'üòä',
        'excited': 'ü§©',
        'neutral': 'üòê',
        'sad': 'üò¢',
        'angry': 'üò†'
    };
    
    if (dayEntries && dayEntries.length > 0) {
        noEntries.style.display = 'none';
        entriesContainer.style.display = 'block';
        
        let html = `<h6 class="text-muted mb-3">${dateStr}</h6>`;
        dayEntries.forEach(entry => {
            const emoji = entry.mood ? moodEmojis[entry.mood] || 'üìù' : 'üìù';
            html += `
                <div class="entry-preview-card">
                    <h6 class="mb-1">
                        <a href="/entry/${entry.id}" class="text-decoration-none" style="color: var(--secondary-color);">
                            ${emoji} ${entry.title}
                        </a>
                    </h6>
                    <p class="text-muted small mb-0">${entry.preview.replace(/<[^>]*>/g, '')}</p>
                </div>
            `;
        });
        entriesContainer.innerHTML = html;
    } else {
        noEntries.style.display = 'block';
        noEntries.innerHTML = `
            <i class="far fa-calendar-alt" style="font-size: 3rem; color: var(--border-color);"></i>
            <p class="mt-3 mb-2">No entries for ${dateStr}</p>
            <a href="/entry/new" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i> Create Entry
            </a>
        `;
        entriesContainer.style.display = 'none';
    }
}

document.getElementById('prevMonth').onclick = () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
};

document.getElementById('nextMonth').onclick = () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
};

// Initial render
renderCalendar();
</script>
{% endblock %}
